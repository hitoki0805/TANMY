<!DOCTYPE html>
<html lang='ja'>
  <head>
    <meta charset='utf-8' />
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- jQueryの追加 -->
    <style>
      .fc-day-sat .fc-daygrid-day-number, .fc-col-header-cell-sat {
        color: blue;
      }
      .fc-day-sun .fc-daygrid-day-number, .fc-col-header-cell-sun, .holiday .fc-daygrid-day-number {
        color: red;
      }
    </style>
    <script type="module">
      import { firebaseConfig } from './APIkeys/firebaseAPI.js';
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
      import { getFirestore, getDocs, collection } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      document.addEventListener('DOMContentLoaded', async function() {
        const holidaysData = await $.get("https://holidays-jp.github.io/api/v1/date.json");
        const unavailableTimes = await loadUnavailableTimes();

        // 初期処理
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'timeGridDay,timeGridWeek,dayGridMonth'
          },
          initialView: 'dayGridMonth',
          navLinks: true, // 日付と週のリンクを有効にする
          editable: true,
          dayMaxEvents: true, // イベントが多い場合には+ボタンで表示
          events: [...getEventDates(holidaysData), ...unavailableTimes],
          eventContent: function(arg) {
            // 祝日の日付にクラスを追加
            if (arg.event.extendedProps.holiday) {
              var element = document.querySelector('.fc-daygrid-day[data-date="' + arg.event.startStr + '"]');
              if (element) {
                element.classList.add("holiday");
              }
            }
            // 予定の名称を表示
            let customHtml = '<div class="fc-event-title">' + arg.event.title + '</div>';
            return { html: customHtml };
          },
          dayCellClassNames: function(arg) {
            if (arg.date.getDay() === 0) {
              return 'fc-sun';
            } else if (arg.date.getDay() === 6) {
              return 'fc-sat';
            }
          }
        });
        calendar.render();
      });

      function getEventDates(holidaysData){
        var eventDates = [];

        var holidays = Object.keys(holidaysData);
        for(var i = 0; i < holidays.length; i++) {
          var holiday = 
          {
            title: holidaysData[holidays[i]],
            start: holidays[i],
            className: "holiday",
            holiday: holidays[i],
            color: 'white'
          };
          eventDates.push(holiday);
        }
        return eventDates; // 返り値を追加
      }

      async function loadUnavailableTimes() {
        const querySnapshot = await getDocs(collection(db, "unavailableTimes"));
        const unavailableTimes = [];
        const today = new Date();
        const endDate = new Date();
        endDate.setMonth(today.getMonth() + 3); // 3ヶ月先までの予定を表示

        querySnapshot.forEach((docSnapshot) => {
          const time = docSnapshot.data();
          const startDate = new Date(time.date);
          const recurrence = time.recurrence;

          if (recurrence === 'none') {
            unavailableTimes.push({
              title: time.name, // 予定の名称を追加
              start: time.date + 'T' + time.startTime,
              end: time.date + 'T' + time.endTime,
              color: 'red'
            });
          } else {
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
              unavailableTimes.push({
                title: time.name, // 予定の名称を追加
                start: currentDate.toISOString().split('T')[0] + 'T' + time.startTime,
                end: currentDate.toISOString().split('T')[0] + 'T' + time.endTime,
                color: 'red'
              });

              if (recurrence === 'daily') {
                currentDate.setDate(currentDate.getDate() + 1);
              } else if (recurrence === 'weekly') {
                currentDate.setDate(currentDate.getDate() + 7);
              } else if (recurrence === 'monthly') {
                currentDate.setMonth(currentDate.getMonth() + 1);
              }
            }
          }
        });
        return unavailableTimes;
      }
    </script>
  </head>
  <body>
    <div id='calendar'></div>
  </body>
</html>