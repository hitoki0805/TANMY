<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>バイトシフト管理アプリ</title>
    <link rel="stylesheet" href="./css/mainpage.css">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- jQueryの追加 -->
    
</head>

<body>
    <header>
        <h1>ホーム画面</h1>
        <nav>
            <ul>
                <li><a href="mainpage.html">ホーム</a></li>
                <li><a href="calendar.html">カレンダー</a></li>
                <li><a href="view-jobs.html">登録済みアルバイト情報</a></li>
                <li><a href="view-schedule.html">登録済み予定</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <div class="container">
            <div>
                <section>
                    <h2>アルバイト情報登録</h2>
                    <p>時給など、バイトに関する基本情報を登録します。</p>
                    <a class="button" href="part-time-job.html">バイト情報を登録する</a>
                </section>
            </div>
            <div>
                <section>
                    <h2>予定登録</h2>
                    <p>授業や他の予定でバイトができない時間を登録します。</p>
                    <a class="button" href="register-unavailable.html">予定を登録する</a>
                </section>
            </div>
        </div>
        <section>
            <h2>カレンダー</h2>
            <div id='calendar'></div>
        </section>

    </main>
    <footer>
        <h2>&copy; 2024 バイトシフト管理アプリ</h2>
    </footer>

    <script type="module">
        import { firebaseConfig } from './APIkeys/firebaseAPI.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
        import { getFirestore, getDocs, collection } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', async function () {
            const holidaysData = await $.get("https://holidays-jp.github.io/api/v1/date.json");
            const unavailableTimes = await loadUnavailableTimes();

            // 初期処理
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'timeGridDay,timeGridWeek,dayGridMonth'
                },
                initialView: 'dayGridMonth',
                navLinks: true, // 日付と週のリンクを有効にする
                editable: true,
                dayMaxEvents: true, // イベントが多い場合には+ボタンで表示
                events: [...getEventDates(holidaysData), ...unavailableTimes],
                eventClick: function(info) {
                    if (!info.event.extendedProps.holiday) { // 祝日でないイベントのみ詳細を表示
                        var eventObj = info.event;
                        var content = `
                            <div class="popup-content">
                                <h3>${eventObj.title}</h3>
                                <p><strong>開始:</strong> ${eventObj.start.toLocaleString()}</p>
                                <p><strong>終了:</strong> ${eventObj.end ? eventObj.end.toLocaleString() : 'なし'}</p>
                            </div>
                        `;
                        // イベントの位置を取得してポップアップを表示
                        const rect = info.el.getBoundingClientRect();
                        showPopup(content, rect.right, rect.top);
                    }
                },
                eventContent: function (arg) {
                    // 祝日の日付にクラスを追加
                    if (arg.event.extendedProps.holiday) {
                        var element = document.querySelector('.fc-daygrid-day[data-date="' + arg.event.startStr + '"]');
                        if (element) {
                            element.classList.add("holiday");
                        }
                    }
                    // 予定の名称を表示
                    let customHtml = '<div class="fc-event-title">' + arg.event.title + '</div>';
                    return { html: customHtml };
                },
                dayCellClassNames: function (arg) {
                    if (arg.date.getDay() === 0) {
                        return 'fc-sun';
                    } else if (arg.date.getDay() === 6) {
                        return 'fc-sat';
                    }
                }
            });
            calendar.render();
        });

        function getEventDates(holidaysData) {
            var eventDates = [];

            var holidays = Object.keys(holidaysData);
            for (var i = 0; i < holidays.length; i++) {
                var holiday =
                {
                    title: holidaysData[holidays[i]],
                    start: holidays[i],
                    className: "holiday",
                    holiday: holidays[i],
                    color: 'red'
                };
                eventDates.push(holiday);
            }
            return eventDates; // 返り値を追加
        }

        async function loadUnavailableTimes() {
            const querySnapshot = await getDocs(collection(db, "unavailableTimes"));
            const unavailableTimes = [];
            const today = new Date();
            const endDate = new Date();
            endDate.setMonth(today.getMonth() + 3); // 3ヶ月先までの予定を表示

            querySnapshot.forEach((docSnapshot) => {
                const time = docSnapshot.data();
                const startDate = new Date(time.date);
                const recurrence = time.recurrence;

                if (recurrence === 'none') {
                    unavailableTimes.push({
                        title: time.name, // 予定の名称を追加
                        start: time.date + 'T' + time.startTime,
                        end: time.date + 'T' + time.endTime,
                        color: 'red'
                    });
                } else {
                    let currentDate = new Date(startDate);
                    while (currentDate <= endDate) {
                        unavailableTimes.push({
                            title: time.name, // 予定の名称を追加
                            start: currentDate.toISOString().split('T')[0] + 'T' + time.startTime,
                            end: currentDate.toISOString().split('T')[0] + 'T' + time.endTime,
                            color: 'red'
                        });

                        if (recurrence === 'daily') {
                            currentDate.setDate(currentDate.getDate() + 1);
                        } else if (recurrence === 'weekly') {
                            currentDate.setDate(currentDate.getDate() + 7);
                        } else if (recurrence === 'monthly') {
                            currentDate.setMonth(currentDate.getMonth() + 1);
                        }
                    }
                }
            });
            return unavailableTimes;
        }

        function showPopup(content, x, y) {
            // 既存のポップアップがあれば削除
            const existingPopup = document.querySelector('.popup');
            if (existingPopup) {
                existingPopup.remove();
            }

            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = content;
            document.body.appendChild(popup);

            // ポップアップの位置を設定
            popup.style.left = `${x}px`;
            popup.style.top = `${y}px`;

            // ポップアップ以外をクリックしたときにポップアップを閉じる
            setTimeout(() => {
                document.addEventListener('click', function removePopup(event) {
                    if (!popup.contains(event.target)) {
                        popup.remove();
                        document.removeEventListener('click', removePopup);
                    }
                });
            }, 0);
        }
    </script>
</body>

</html>
